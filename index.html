<!DOCTYPE HTML>
<html lang="en">
  <head>
     <!-- bootstrap  -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!-- All above bootsrtap -->




    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <!-- <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
    />
    <script
      src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
    ></script> -->
    <link rel = "stylesheet" type = "text/css" href = "index.css"/>
    


  </head>
  <body>
    <div id="map"><form onclick='button_add_press("map")' class="button-to-add"><input type="button" value="+"></input></form></div>

    <div id="container">
      <form action="https://superroad.herokuapp.com/write" method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <!-- <label for="ISBN">ISBN</label> -->
            <!-- <input class="form-control" name="lat"> -->
            <input type="hidden"  id="lat" name="lat" value="1">
		        <input type="hidden"  id="lng" name="lng" value="1">
        </div>

        <div class="form-group">
            <label for="Tags">Tags</label>
            <input class="form-control" name="tag">
        </div>

        <div class="form-group">
            <label for="Title">Description</label>
            <input class="form-control" name="description">
        </div>


        <div class="form-group">
            <label for="Image">Image</label>
            <input type="file"  id ="image" name="avatar">
        </div>

        <!--Other fields-->
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>
      <div class="close">
        <button onclick='button_add_press("map")'>Close</button>
      </div>
      <p></p>
      <div id="issMap"></div>
    </div>
    





    <script>
      var xweb=0;
      var yweb=0;

      function getLocation() {
        if(navigator.geolocation){
          navigator.geolocation.watchPosition(showPosition);
          // setTimeout(() => {
          //   secondFunction();
          // },5000);
          // callback();
        } else {
          x.innerHTML = "Geolocation is not supported by this browser.";
          // alert("Geolocation is not supported by this browser.");
        }
        
      }

      function showPosition(position) {
        yweb = position.coords.latitude;
        xweb = position.coords.longitude;
        console.log(xweb+' '+yweb);
        document.getElementById('lat').setAttribute('value', xweb);
        document.getElementById('lng').setAttribute('value', yweb);
        console.log("set-defaults"+xweb+","+yweb);
        map.setView({lon: xweb,lat: yweb},6);
        mymap.setView({lon: xweb,lat: yweb},6);
        
        console.log("set-defaults"+xweb+","+yweb);
        // onClickMarker(null);
        // currentMarker = L.marker({lon:xweb,lat:yweb}).addTo(mymap);
        // map = L.map('map').setView({lon: 3, lat: 3}, 6);
      }
      

      getLocation();

      

      secondFunction();
      // initialize Leaflet
      function secondFunction(){
        console.log(xweb+' '+yweb);
        var map = L.map('map').setView({lon: xweb, lat: yweb}, 6);
        map.locate({setView: true, maxZoom: 14}); 
        // map = L.map('map').setView({lon: 3, lat: 3}, 6);
        // add the OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
          , noWrap: true}).addTo(map);
        L.control.scale().addTo(map);
        // const data = "localhost:3000/all";
        const data = "https://superroad.herokuapp.com/all";
        var request = new Request(data);
        fetch(request).then(function(response) {
          return response.text();
        }).then(function(text) {
          // console.log(text.substring(0, 30));
          var objectJson = JSON.parse(text);
          objectJson.forEach(x =>{
            console.log(x.lng+","+x.lat+","+x.data);
            pointOperation(x.lng,x.lat,x.data);
          });

        });
        function pointOperation(x,y,array){
          function rendersList(array) {
          var outputString="<div class=\"pop-up\">";
          array.forEach(element => {
            let post = element;
            outputString += "<div class=\"card\" style=\"width: 18rem;\">"
              outputString += '<img src="http://superroad.herokuapp.com/'+post.image+'" class="card-img-top">';
            outputString+= "<div class=\"card-body\">"
            outputString+= "<h5 class=\"card-title\">"+post.time+"</h5>"
            outputString+= "<p class=\"card-text\">"+post.description+"</p>"
            outputString+= "<p class=\"card-text\">";
            post.tags.forEach(ele =>{
              outputString += ele+",";
            });
            outputString = outputString.substring(0,outputString.length-1);
            outputString += "</p>";
            outputString+="</div> </div>"
            outputString += "</br>"
          });
          return outputString+"</div>";
          }
          L.marker({lon: x, lat: y}).bindPopup(rendersList(array)).addTo(map);
        }

        


        var mymap = L.map('issMap').setView({lon: xweb,lat: yweb}, 6);
        const attribution =
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

        const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        const tiles = L.tileLayer(tileUrl, { attribution, noWrap: true});
        tiles.addTo(mymap);
        mymap.locate({setView: true, maxZoom: 14}); 
        var isPointed = false;
        var currentMarker = L.marker();
        // currentMarker.on('click',onClickMarker);
        function onMapClick(e) {
        if (!isPointed){
          // alert("You clicked the map at " + e.latlng);
          currentMarker = L.marker(e.latlng).addTo(mymap);
          
          currentMarker.on('click',onClickMarker);
          // document.getElementById('lat').setAttribute('value', e.latlng.lat);
          // document.getElementById('lng').setAttribute('value', e.latlng.lng);
          document.getElementById('lat').setAttribute('value', e.latlng.lat);
			    document.getElementById('lng').setAttribute('value', e.latlng.lng);
          // document.getElementById("latText").innerHTML = e.latlng.lat;
          // document.getElementById("lnText").innerHTML = e.latlng.lng;
          isPointed = true;
        }
        }
        mymap.on('click', onMapClick);
        
        function onClickMarker(e){
          console.log(e);
          // currentMarker.remove();
          mymap.removeLayer(currentMarker);
          isPointed = false;
          // document.getElementById('lat').setAttribute('value', '1')
          // document.getElementById('ln').setAttribute('value', '1')
        }
      }
      // currentMarker.on('click',onClickMarker);
		
      // secondFunction();


      function button_add_press(value){
          var x = document.getElementById(value);
          
          if (x.style.display === "none") {
            x.style.display = "block";
            console.log("map is none")
          } else {
            x.style.display = "none";
            console.log("map is block")
          }
        }
        function return_to_map(){
          var y = document.getElementById("container");
          console.log(y.style.display)
          if (y.style.display === "none") {
            y.style.display = "block";
            console.log("container is none")
          } else {
            y.style.display = "none";
            console.log("container is block")
          }
        }


    </script>
    
  </body>
